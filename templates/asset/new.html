{% extends "base.html" %}

{% block style %}

.form-row input[type=text] {
	margin-left: 18px;
}

.form-row ul li {
	list-style: none;
	display: inline;
}

#map_canvas {
	width: 100%; 
	height: 400px;
	margin-bottom: 18px;
}

h3 {
	margin-top: 18px;
}

{% endblock %}

{% block javascript %}

<script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.5.2.min.js" type="text/javascript"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>

<script type="text/javascript">

$(document).ready(function() {

	var station = new google.maps.LatLng(42.4166293422, -71.1281383942);
	
	var mapOptions = {
		zoom: 14,
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		center: station
	};
 
	var map = new google.maps.Map(document.getElementById("map_canvas"),
		mapOptions);
		
	var marker_station = new google.maps.Marker({
		map: map,
		title: "Proposed Green Line Station",
		position: station,
		icon: "{{ MEDIA_URL }}img/train.png"
	});
	
	var asset = new google.maps.LatLng(42.4166293422, -71.1281383942);
	
	var markerAsset = new google.maps.Marker({
		position: asset,
		draggable:true,
		animation: google.maps.Animation.DROP, 
		map: map, 
		title:"New Asset"
	});
	
	// animation
	google.maps.event.addListener(markerAsset, 'click', toggleBounce);
	// track marker dragging		
	google.maps.event.addListener(markerAsset, 'dragend', function() {
		// write loc coord to hidden geometry field (in WGS84)
		$("#id_location").val("POINT (" + markerAsset.position.lng() + " " +  markerAsset.position.lat() + ")");
		// validate location
		validation["marker"] = true;		
	});
	
	function toggleBounce() {
		if (markerAsset.getAnimation() != null) {
			markerAsset.setAnimation(null);
		} else {
			markerAsset.setAnimation(google.maps.Animation.BOUNCE);
		}
	}
	
	// form validation
	var validation = {
		"formerror":{% if formerror %} true {% else %} false {% endif %},
		"marker": false // location not set
	};
	
	$("#assetform").submit(function() {
		
		// alert($("#id_location").val());
		
		// check location field
		if ($("#id_location").val() === "POINT(0 0)") {
			validation.marker = false;
		} else {
			// required for django validation error page-reload
			validation.marker = true;
		}
		
      	// no location provided, harder to check with django form validation
		if (validation.marker === false) {
			alert("Please drag the marker to your asset location.");
	      	return false;
		}

   });    
});

</script>

{% endblock %}

{% block body %}

<div class="prepend-2 span-20 append-2 last">

<h2>Add new asset</h2>

<form id="assetform" action="." method="post">

{% csrf_token %}

<fieldset>
	
	<p>Please drag the marker to your asset location:</p>
	<div id="map_canvas"></div>
	
	{{ form.location }}
	
	<div class="form-row">
	{% if form.title.errors %}
	<div class="error">
		{% for error in form.title.errors %}
			{{ error|escape }}<br>
		{% endfor %}
		<label class="large">Please provide an asset title:</label><br> {{ form.title }}
	</div>
	{% else %}
	<label class="large">Please provide an asset title:</label><br> {{ form.title }}
	{% endif %}	
	</div>
	
	<div class="form-row">
		
		{{ form.category.errors }}
		<label class="large">Please select an asset category:</label> {{ form.category }}
		
	</div>
	
</fieldset>

<input type="submit" value="Add!" />
</form>

<h3>Instructions for mapping assets</h3>
<ol>
<li>Drag the red asset marker to the location of the asset you wish to map.</li>
<li>You can zoom in or out or pan using your mouse or the controls on the left side of the map.  You can also toggle between the road map and a satellite image.</li>
<li>After you have placed your asset marker, please provide a title for the asset in the title box.</li>
<li>Select whether the asset should be a preservation or change marker.</li>
<li>Click the "Add!" button.</li>
<li>If you wish to add a new comment to your asset, click the “add a new comment” link.</li>
<li>If you wish to another asset, click on the "add another asset” link.</li>
</ol>

</div>

{% endblock %}